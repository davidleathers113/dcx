// schema.prisma
// Dependable Call Exchange (DCX) â€“ Core Data Model
// DB: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS

enum SupplierType {
  INTERNAL_CALL_CENTER
  EXTERNAL_PUBLISHER
  NETWORK
}

enum Status {
  ACTIVE
  INACTIVE
}

enum EndpointType {
  PHONE_NUMBER
  SIP
}

enum PricingModel {
  CPA
  FIXED
  CPC
  REVSHARE
}

enum PoolType {
  STATIC
  DYNAMIC
}

enum CallStatus {
  INITIATED
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  BUSY
  NO_ANSWER
}

enum RecordingConsentSource {
  IMPLICIT_IVR
  AGENT_VERBAL
  NONE
}

enum TranscriptionStatus {
  NONE
  PENDING
  COMPLETED
  FAILED
}

enum StirShakenAttestation {
  A
  B
  C
  UNKNOWN
}

enum AiJobType {
  TRANSCRIBE
  QA_EVAL
}

enum AiJobStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

// MODELS

model Supplier {
  id           String       @id @default(cuid())
  name         String
  type         SupplierType
  contactEmail String?      @map("contact_email")
  contactPhone String?      @map("contact_phone")
  status       Status       @default(ACTIVE)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  // Relations
  campaigns    Campaign[]
  numbers      PhoneNumber[]
  callSessions CallSession[]

  @@index([status])
  @@map("suppliers")
}

model Buyer {
  id               String       @id @default(cuid())
  name             String
  endpointType     EndpointType @map("endpoint_type")
  endpointValue    String       @map("endpoint_value")
  concurrencyLimit Int          @map("concurrency_limit")
  dailyCap         Int?         @map("daily_cap")
  status           Status       @default(ACTIVE)
  weight           Int          @default(50)
  scheduleTimezone String?      @map("schedule_timezone")
  scheduleRules    Json?        @map("schedule_rules")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  offers           Offer[]
  callSessions     CallSession[]
  conversionEvents ConversionEvent[]

  @@index([status])
  @@map("buyers")
}

model Campaign {
  id                      String   @id @default(cuid())
  name                    String
  vertical                String
  geoRules                Json?    @map("geo_rules")
  supplierId              String?  @map("supplier_id")
  status                  Status   @default(ACTIVE)
  recordingDefaultEnabled Boolean  @default(true) @map("recording_default_enabled")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  // Relations
  supplier     Supplier?   @relation(fields: [supplierId], references: [id])
  offers       Offer[]
  numbers      PhoneNumber[]
  callSessions CallSession[]

  @@index([status])
  @@index([supplierId])
  @@map("campaigns")
}

model Offer {
  id                    String       @id @default(cuid())
  buyerId               String       @map("buyer_id")
  campaignId            String       @map("campaign_id")
  pricingModel          PricingModel @map("pricing_model")
  payoutCents           Int          @map("payout_cents")              // cents
  bufferSeconds         Int          @default(60) @map("buffer_seconds")
  attributionWindowDays Int          @default(30) @map("attribution_window_days")
  dailyCap              Int?         @map("daily_cap")
  priority              Int          @default(100)
  weight                Int          @default(50)
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")

  // Relations
  buyer       Buyer        @relation(fields: [buyerId], references: [id])
  campaign    Campaign     @relation(fields: [campaignId], references: [id])
  callSessions CallSession[]

  // Fast lookup for routing: find active offers for a campaign in priority order
  @@index([campaignId, isActive, priority])
  @@index([buyerId, isActive])
  @@map("offers")
}

model PhoneNumber {
  id                    String                @id @default(cuid())
  twilioSid             String                @unique @map("twilio_sid")
  e164                  String                @unique
  campaignId            String                @map("campaign_id")
  supplierId            String                @map("supplier_id")
  poolType              PoolType              @map("pool_type")
  status                Status                @default(ACTIVE)
  trustProfileId        String?               @map("trust_profile_id")
  stirShakenAttestation StirShakenAttestation? @map("stir_shaken_attestation")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id])
  supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([campaignId])
  @@index([supplierId])
  @@index([campaignId, supplierId])
  @@map("phone_numbers")
}

model CallSession {
  id                      String            @id @default(cuid())
  publicId                String            @unique @map("public_id")
  traceId                 String            @map("trace_id")
  twilioCallSid           String            @unique @map("twilio_call_sid")

  fromNumber              String            @map("from_number")
  toNumber                String            @map("to_number")
  campaignId              String            @map("campaign_id")
  supplierId              String            @map("supplier_id")
  buyerId                 String?           @map("buyer_id")
  offerId                 String?           @map("offer_id")

  status                  CallStatus

  createdAt               DateTime          @default(now()) @map("created_at")
  answeredAt              DateTime?         @map("answered_at")
  endedAt                 DateTime?         @map("ended_at")

  durationSeconds         Int               @default(0) @map("duration_seconds")
  billableDurationSeconds Int               @default(0) @map("billable_duration_seconds")

  telephonyCostCents      Int               @default(0) @map("telephony_cost_cents")      // cents
  revenueEstimatedCents   Int               @default(0) @map("revenue_estimated_cents")   // cents

  recordingEnabled        Boolean           @default(false) @map("recording_enabled")
  recordingUrl            String?           @map("recording_url")
  recordingConsentSource  RecordingConsentSource? @map("recording_consent_source")

  transcriptionStatus     TranscriptionStatus @default(NONE) @map("transcription_status")
  transcriptionText       String?           @map("transcription_text")
  sentimentScore          Float?            @map("sentiment_score")
  llmQaScore              Float?            @map("llm_qa_score")

  createdBy               String?           @map("created_by")
  updatedAt               DateTime          @updatedAt @map("updated_at")

  // Relations
  campaign        Campaign        @relation(fields: [campaignId], references: [id])
  supplier        Supplier        @relation(fields: [supplierId], references: [id])
  buyer           Buyer?          @relation(fields: [buyerId], references: [id])
  offer           Offer?          @relation(fields: [offerId], references: [id])
  conversionEvents ConversionEvent[]
  aiJobs          CallAiJob[]

  // Reporting & routing-friendly indexes
  @@index([campaignId, createdAt])
  @@index([supplierId, createdAt])
  @@index([buyerId, createdAt])
  @@index([status])
  @@map("call_sessions")
}

model ConversionEvent {
  id            String   @id @default(cuid())
  callSessionId String   @map("call_session_id")
  buyerId       String   @map("buyer_id")
  eventType     String   @map("event_type")
  eventTime     DateTime @map("event_time")
  revenueCents  Int?     @map("revenue_cents")  // cents
  source        String
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id])
  buyer       Buyer       @relation(fields: [buyerId], references: [id])

  @@index([callSessionId])
  @@index([buyerId, eventTime])
  @@map("conversion_events")
}

model CallAiJob {
  id            String     @id @default(cuid())
  callSessionId String     @map("call_session_id")
  jobType       AiJobType  @map("job_type")
  status        AiJobStatus @map("status")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  callSession CallSession @relation(fields: [callSessionId], references: [id])

  @@index([callSessionId, jobType, status])
  @@map("call_ai_jobs")
}
